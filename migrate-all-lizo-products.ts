// üéØ MIGRACI√ìN COMPLETA: TODOS LOS PRODUCTOS REALES DE LIZO
// Ejecutar con: npx tsx migrate-all-lizo-products.ts

import { supabase, supabaseService } from './lib/supabase'
import { productosLizoCompletos, getEstadisticasLizo } from './productos-lizo-completos'

async function migrateAllLizoProducts() {
  console.log('üé® ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
  console.log('   MIGRACI√ìN COMPLETA - BASE DE DATOS LIZO BELLEZA')
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n')

  // Mostrar estad√≠sticas antes de migrar
  const stats = getEstadisticasLizo()
  console.log('üìä RESUMEN DE PRODUCTOS A MIGRAR:')
  console.log(`   ‚Ä¢ Total de productos: ${stats.totalProductos}`)
  console.log(`   ‚Ä¢ Total de categor√≠as: ${stats.totalCategorias}`)
  console.log(`   ‚Ä¢ Productos destacados: ${stats.totalDestacados}`)
  console.log(`   ‚Ä¢ Best sellers: ${stats.totalBestsellers}\n`)

  console.log('üìÇ PRODUCTOS POR CATEGOR√çA:')
  stats.porCategoria.forEach(cat => {
    console.log(`   ‚Ä¢ ${cat.categoria}: ${cat.total} productos (${cat.destacados} destacados, ${cat.bestsellers} bestsellers)`)
    console.log(`     Rango de precios: $${cat.precioMin.toLocaleString()} - $${cat.precioMax.toLocaleString()}`)
  })

  console.log('\n' + '‚îÄ'.repeat(60))
  console.log('‚ö†Ô∏è  IMPORTANTE: Este script necesita que hayas ejecutado')
  console.log('   extend-products-schema.sql en Supabase SQL Editor primero.')
  console.log('‚îÄ'.repeat(60))

  // Esperar 3 segundos para que el usuario lea
  console.log('\n‚è≥ Iniciando migraci√≥n en 3 segundos...\n')
  await new Promise(resolve => setTimeout(resolve, 3000))

  try {
    // ==================== PASO 1: VERIFICAR TABLA ====================
    console.log('üìã PASO 1: Verificando tabla products...')
    
    const { data: testQuery, error: testError } = await supabase
      .from('products')
      .select('id')
      .limit(1)
    
    if (testError) {
      throw new Error(`No se puede acceder a la tabla products: ${testError.message}`)
    }
    
    console.log('‚úÖ Tabla products accesible\n')

    // ==================== PASO 2: MIGRAR PRODUCTOS ====================
    console.log(`üìã PASO 2: Migrando ${productosLizoCompletos.length} productos...\n`)
    
    let successCount = 0
    let errorCount = 0
    const errors: any[] = []

    for (let i = 0; i < productosLizoCompletos.length; i++) {
      const producto = productosLizoCompletos[i]
      
      try {
        // Calcular ratings y reviews basados en si es bestseller o destacado
        const rating = producto.bestseller ? 4.9 : producto.destacado ? 4.7 : 4.5
        const reviews = producto.bestseller ? Math.floor(Math.random() * 300) + 200 : 
                       producto.destacado ? Math.floor(Math.random() * 150) + 50 : 
                       Math.floor(Math.random() * 50) + 10

        const productData = {
          name: producto.nombre,
          description: producto.descripcion || `${producto.nombre} - Producto profesional de alta calidad`,
          price: producto.precio,
          original_price: Math.floor(producto.precio * 1.25), // 25% descuento
          category: producto.categoria,
          image_url: producto.imagen || '/imagenes lizo/default.png',
          images: [producto.imagen || '/imagenes lizo/default.png'], // Array con imagen principal
          features: [
            'Calidad profesional',
            'Garant√≠a LIZO',
            'Env√≠o nacional',
            producto.bestseller ? 'Best Seller' : 'Producto destacado'
          ],
          stock: Math.floor(Math.random() * 50) + 10, // Stock entre 10-60
          in_stock: producto.enStock,
          featured: producto.destacado,
          bestseller: producto.bestseller,
          rating: rating,
          reviews: reviews,
          sales_count: producto.bestseller ? reviews : Math.floor(reviews / 2),
          revenue: producto.precio * (producto.bestseller ? reviews : Math.floor(reviews / 2))
        }

        const { data, error } = await supabase
          .from('products')
          .insert([productData])
          .select()

        if (error) {
          console.error(`‚ùå [${i+1}/${productosLizoCompletos.length}] ${producto.nombre}`)
          console.error(`   Error: ${error.message}`)
          errors.push({ 
            producto: producto.nombre, 
            categoria: producto.categoria,
            error: error.message 
          })
          errorCount++
        } else {
          const icon = producto.bestseller ? 'üî•' : producto.destacado ? '‚≠ê' : '‚úÖ'
          console.log(`${icon} [${i+1}/${productosLizoCompletos.length}] ${producto.nombre} (${producto.categoria})`)
          successCount++
        }

        // Pausa peque√±a para no saturar la API
        await new Promise(resolve => setTimeout(resolve, 50))
        
      } catch (err: any) {
        console.error(`‚ùå [${i+1}/${productosLizoCompletos.length}] ${producto.nombre}`)
        console.error(`   Error: ${err.message}`)
        errors.push({ 
          producto: producto.nombre, 
          categoria: producto.categoria,
          error: err.message 
        })
        errorCount++
      }
    }

    // ==================== PASO 3: RESUMEN ====================
    console.log('\n' + '‚ïê'.repeat(60))
    console.log('üìä RESUMEN DE MIGRACI√ìN')
    console.log('‚ïê'.repeat(60))
    console.log(`‚úÖ Productos insertados: ${successCount}`)
    console.log(`‚ùå Errores: ${errorCount}`)
    console.log(`üì¶ Total procesados: ${productosLizoCompletos.length}`)
    console.log(`üìà Tasa de √©xito: ${((successCount / productosLizoCompletos.length) * 100).toFixed(1)}%`)

    if (errors.length > 0) {
      console.log('\n‚ö†Ô∏è  ERRORES DETALLADOS:')
      const errorsByCategory = errors.reduce((acc: any, e) => {
        acc[e.categoria] = (acc[e.categoria] || 0) + 1
        return acc
      }, {})
      
      Object.entries(errorsByCategory).forEach(([cat, count]) => {
        console.log(`   ‚Ä¢ ${cat}: ${count} error(es)`)
      })

      console.log('\n   PRODUCTOS CON ERROR:')
      errors.slice(0, 10).forEach(e => {
        console.log(`   - ${e.producto} (${e.categoria}): ${e.error}`)
      })
      if (errors.length > 10) {
        console.log(`   ... y ${errors.length - 10} error(es) m√°s`)
      }
    }

    // ==================== PASO 4: VERIFICACI√ìN ====================
    if (successCount > 0) {
      console.log('\n' + '‚ïê'.repeat(60))
      console.log('üìà VERIFICACI√ìN DE BASE DE DATOS')
      console.log('‚ïê'.repeat(60))

      const allProducts = await supabaseService.getProducts()
      console.log(`\nüì¶ Total productos en DB: ${allProducts?.length || 0}`)

      const featured = await supabaseService.getFeaturedProducts()
      console.log(`‚≠ê Productos destacados: ${featured?.length || 0}`)

      const bestsellers = await supabaseService.getBestsellers()
      console.log(`üî• Best sellers: ${bestsellers?.length || 0}`)

      // Top 5 por categor√≠a
      console.log('\nüìÇ TOP 3 PRODUCTOS POR CATEGOR√çA:')
      const categorias = ['Secadores', 'Planchas', 'Pinzas', 'Patilleras y Cortadoras', 'Cepillos', 'Tijeras', 'Barber√≠a', 'Spa y Belleza']
      
      for (const categoria of categorias) {
        const catProducts = await supabaseService.getProductsByCategory(categoria)
        if (catProducts && catProducts.length > 0) {
          console.log(`\n   ${categoria} (${catProducts.length} productos):`)
          catProducts
            .sort((a, b) => b.rating - a.rating)
            .slice(0, 3)
            .forEach((p, i) => {
              const badge = p.bestseller ? 'üî•' : p.featured ? '‚≠ê' : '  '
              console.log(`   ${i+1}. ${badge} ${p.name} - $${p.price.toLocaleString()} (${p.rating}/5)`)
            })
        }
      }

      // Top 10 productos generales
      const topRated = allProducts
        ?.sort((a, b) => b.rating - a.rating)
        .slice(0, 10) || []
      
      if (topRated.length > 0) {
        console.log('\n‚≠ê TOP 10 PRODUCTOS MEJOR VALORADOS:')
        topRated.forEach((p, i) => {
          const badge = p.bestseller ? 'üî•' : p.featured ? '‚≠ê' : '  '
          console.log(`   ${i+1}. ${badge} ${p.name} - ${p.rating}/5 (${p.reviews} rese√±as)`)
        })
      }

      // Top ventas
      const topSellers = allProducts
        ?.sort((a, b) => b.sales_count - a.sales_count)
        .slice(0, 10) || []
      
      if (topSellers.length > 0) {
        console.log('\nüî• TOP 10 PRODUCTOS M√ÅS VENDIDOS:')
        topSellers.forEach((p, i) => {
          console.log(`   ${i+1}. ${p.name} - ${p.sales_count} ventas ($${p.revenue.toLocaleString()})`)
        })
      }

      // Revenue total
      const totalRevenue = allProducts?.reduce((sum, p) => sum + (p.revenue || 0), 0) || 0
      console.log(`\nüí∞ Revenue total: $${totalRevenue.toLocaleString()}`)
    }

    // ==================== PASO 5: PR√ìXIMOS PASOS ====================
    console.log('\n' + '‚ïê'.repeat(60))
    console.log('‚ú® MIGRACI√ìN COMPLETADA')
    console.log('‚ïê'.repeat(60))

    if (successCount === productosLizoCompletos.length) {
      console.log('\nüéâ ¬°PERFECTO! Todos los productos fueron migrados exitosamente\n')
    } else if (successCount > 0) {
      console.log(`\n‚ö†Ô∏è  Se migraron ${successCount} de ${productosLizoCompletos.length} productos`)
      console.log('   Revisa los errores arriba para ver qu√© fall√≥\n')
    } else {
      console.log('\n‚ùå No se pudo migrar ning√∫n producto')
      console.log('   Aseg√∫rate de haber ejecutado extend-products-schema.sql primero\n')
    }

    console.log('üí° PR√ìXIMOS PASOS:')
    console.log('   1. ‚úÖ Productos en Supabase')
    console.log('   2. üîç Verificar en: https://supabase.com/dashboard/project/qlgtbreqoyjhycpnbzoz/editor/products')
    console.log('   3. üé® Actualizar app/page.tsx para usar la base de datos')
    console.log('   4. üöÄ Ver productos en: http://localhost:3001')
    console.log('   5. üìä Crear p√°gina de cat√°logo completo con filtros')

    console.log('\nüìö DOCUMENTACI√ìN:')
    console.log('   ‚Ä¢ productos-lizo-completos.ts - Base de datos local')
    console.log('   ‚Ä¢ lib/supabase.ts - Funciones de base de datos')
    console.log('   ‚Ä¢ INSTRUCCIONES-MIGRACION-RAPIDA.md - Gu√≠a completa')

    console.log('\n' + '‚ïê'.repeat(60) + '\n')

  } catch (error: any) {
    console.error('\n‚ùå ERROR CR√çTICO:', error.message)
    console.error(error)
    
    console.log('\nüí° SOLUCI√ìN:')
    console.log('   1. Ve a: https://supabase.com/dashboard/project/qlgtbreqoyjhycpnbzoz/sql')
    console.log('   2. Ejecuta el contenido de: extend-products-schema.sql')
    console.log('   3. Vuelve a ejecutar: npx tsx migrate-all-lizo-products.ts')
    
    process.exit(1)
  }
}

// Ejecutar migraci√≥n
console.log('\n')
migrateAllLizoProducts()
  .then(() => {
    console.log('üëã Migraci√≥n finalizada\n')
    process.exit(0)
  })
  .catch((error) => {
    console.error('\nüí• Error fatal:', error.message)
    process.exit(1)
  })
